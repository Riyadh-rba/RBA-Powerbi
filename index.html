<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>لوحة مؤشرات - شركة رياض بن بليهد للاستشارات المحاسبية</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- خط عربي جميل -->
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <!-- ApexCharts -->
  <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>

  <style>
    :root {
      --bg: #f4f6fb;
      --card: #ffffff;
      --primary: #0b5f5a;
      --primary-dark: #084c48;
      --primary-soft: #e0f2f1;
      --accent: #f9a825;
      --danger: #c62828;
      --text-main: #1f2933;
      --text-muted: #7b8794;
      --border: #e0e7ff;
      --radius-lg: 18px;
      --radius-md: 12px;
      --shadow: 0 18px 50px rgba(15, 23, 42, 0.14);
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: "Cairo", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background:
        radial-gradient(circle at top left, rgba(224,242,241,0.9) 0, transparent 55%),
        radial-gradient(circle at bottom right, rgba(237,231,246,0.9) 0, transparent 55%),
        var(--bg);
      color: var(--text-main);
      min-height: 100vh;
    }

    /* LOGIN SCREEN */
    .login-screen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      transition: opacity 0.3s ease;
      padding: 20px;
    }

    .login-screen.hidden {
      opacity: 0;
      pointer-events: none;
    }

    .login-container {
      background: white;
      border-radius: 24px;
      padding: 40px 30px;
      width: 100%;
      max-width: 420px;
      box-shadow: 0 25px 50px rgba(11, 95, 90, 0.1);
      text-align: center;
      position: relative;
      overflow: hidden;
    }

    .login-container::before {
      content: "";
      position: absolute;
      top: 0;
      right: 0;
      width: 100%;
      height: 5px;
      background: linear-gradient(90deg, var(--primary) 0%, var(--accent) 100%);
    }

    .login-logo {
      margin-bottom: 30px;
    }

    .logo-svg {
      width: 100px;
      height: 100px;
      margin: 0 auto 20px;
    }

    .login-title {
      font-size: 24px;
      color: var(--primary);
      margin: 0 0 8px;
      font-weight: 700;
    }

    .login-subtitle {
      color: var(--text-muted);
      font-size: 14px;
      margin-bottom: 30px;
    }

    .login-form {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .form-group {
      text-align: right;
    }

    .form-label {
      display: block;
      margin-bottom: 8px;
      color: var(--text-main);
      font-weight: 600;
      font-size: 14px;
    }

    .form-input {
      width: 100%;
      padding: 14px 16px;
      border: 2px solid var(--border);
      border-radius: 12px;
      font-size: 15px;
      font-family: inherit;
      transition: all 0.3s ease;
      background: #f8fafc;
    }

    .form-input:focus {
      outline: none;
      border-color: var(--primary);
      background: white;
      box-shadow: 0 0 0 3px rgba(11, 95, 90, 0.1);
    }

    .login-btn {
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
      color: white;
      border: none;
      padding: 16px;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      font-family: inherit;
      margin-top: 10px;
      position: relative;
      overflow: hidden;
    }

    .login-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 20px rgba(11, 95, 90, 0.3);
    }

    .login-btn:active {
      transform: translateY(0);
    }

    .login-error {
      color: var(--danger);
      font-size: 14px;
      margin-top: 10px;
      min-height: 20px;
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .login-error.show {
      opacity: 1;
    }

    /* LOGOUT BUTTON */
    .logout-container {
      position: fixed;
      top: 20px;
      left: 20px;
      z-index: 100;
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .logout-container.visible {
      opacity: 1;
    }

    .logout-btn {
      background: white;
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 10px 16px;
      font-size: 13px;
      color: var(--primary);
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: all 0.3s ease;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
      white-space: nowrap;
    }

    .logout-btn:hover {
      background: var(--primary-soft);
      transform: translateY(-2px);
      box-shadow: 0 8px 16px rgba(11, 95, 90, 0.15);
    }

    .logout-btn:active {
      transform: translateY(0);
    }

    .logout-btn svg {
      width: 16px;
      height: 16px;
    }

    /* MAIN DASHBOARD */
    .shell {
      max-width: 1400px;
      margin: 20px auto 32px;
      padding: 0 16px;
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .shell.visible {
      opacity: 1;
    }

    /* HEADER */
    .header {
      background: linear-gradient(120deg, #f3e5f5, #e3f2fd);
      border-radius: 24px;
      padding: 18px 22px;
      box-shadow: var(--shadow);
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      justify-content: space-between;
      align-items: flex-start;
      position: relative;
      overflow: hidden;
      margin-top: 60px;
    }

    .header::before {
      content: "";
      position: absolute;
      inset-inline-end: -40px;
      top: -40px;
      width: 180px;
      height: 180px;
      background: radial-gradient(circle, rgba(11,95,90,0.18) 0, transparent 65%);
      opacity: .9;
    }

    .header-main {
      position: relative;
      z-index: 1;
      display: flex;
      align-items: center;
      gap: 20px;
    }

    .header-logo {
      width: 60px;
      height: 60px;
      flex-shrink: 0;
    }

    .header-title {
      font-size: 24px;
      margin: 0 0 4px;
      font-weight: 700;
    }

    .header-subtitle {
      margin: 0;
      font-size: 13px;
      color: var(--text-muted);
    }

    .header-tag {
      position: relative;
      z-index: 1;
      padding: 6px 12px;
      border-radius: 999px;
      background: rgba(255,255,255,0.9);
      border: 1px solid rgba(148,163,184,0.3);
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 12px;
      color: var(--primary);
      margin-top: 8px;
    }

    .header-tag-dot {
      width: 7px;
      height: 7px;
      border-radius: 50%;
      background: var(--primary);
    }

    .year-filter {
      position: relative;
      z-index: 1;
      display: flex;
      flex-direction: column;
      gap: 6px;
      align-items: flex-end;
    }

    .year-label {
      font-size: 13px;
      color: var(--text-muted);
    }

    .year-buttons {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    .year-btn {
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.4);
      background: rgba(255,255,255,0.9);
      padding: 6px 14px;
      font-size: 13px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: all .18s ease;
      user-select: none;
    }

    .year-btn-dot {
      width: 10px;
      height: 10px;
      border-radius: 999px;
      border: 2px solid rgba(148,163,184,0.7);
      background: transparent;
      transition: all .18s ease;
    }

    .year-btn-active {
      border-color: var(--primary);
      background: var(--primary-soft);
      color: var(--primary);
    }

    .year-btn-active .year-btn-dot {
      border-color: var(--primary);
      background: var(--primary);
    }

    .year-hint {
      font-size: 11px;
      color: var(--text-muted);
    }

    .year-hint span {
      color: var(--accent);
      font-weight: 600;
    }

    /* TABS */
    .tabs {
      margin-top: 18px;
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .tab-btn {
      border: none;
      border-radius: 999px;
      padding: 7px 18px;
      font-size: 14px;
      cursor: pointer;
      background: rgba(255,255,255,0.9);
      color: var(--text-muted);
      display: inline-flex;
      align-items: center;
      gap: 6px;
      box-shadow: 0 1px 3px rgba(15,23,42,0.08);
      transition: all .18s ease;
    }

    .tab-dot {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: rgba(148,163,184,0.9);
    }

    .tab-active {
      background: var(--primary);
      color: #e0f2f1;
      box-shadow: 0 12px 30px rgba(11,95,90,0.35);
    }

    .tab-active .tab-dot {
      background: #e0f2f1;
    }

    /* LAYOUT */
    .layout {
      margin-top: 16px;
      display: grid;
      grid-template-columns: minmax(0, 1.6fr) minmax(0, 1.6fr);
      gap: 18px;
      align-items: start;
    }

    .panel {
      background: var(--card);
      border-radius: var(--radius-lg);
      padding: 16px 18px 18px;
      box-shadow: var(--shadow);
      position: relative;
      overflow: hidden;
    }

    .panel::before {
      content: "";
      position: absolute;
      inset-inline-start: -40px;
      bottom: -60px;
      width: 160px;
      height: 160px;
      background: radial-gradient(circle, rgba(11,95,90,0.09) 0, transparent 60%);
    }

    .panel-inner {
      position: relative;
      z-index: 1;
    }

    .panel-header {
      display: flex;
      justify-content: space-between;
      gap: 10px;
      align-items: flex-start;
      margin-bottom: 10px;
    }

    .panel-title {
      margin: 0;
      font-size: 16px;
      font-weight: 600;
    }

    .panel-subtitle {
      margin: 2px 0 0;
      font-size: 12px;
      color: var(--text-muted);
    }

    .panel-meta {
      font-size: 11px;
      color: var(--text-muted);
      text-align: left;
    }

    .kpis {
      margin-top: 8px;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 10px;
    }

    .kpi-card {
      background: linear-gradient(135deg, #ffffff, #f0f4ff);
      border-radius: var(--radius-md);
      padding: 10px 11px 9px;
      border: 1px solid rgba(148,163,184,0.3);
      box-shadow: 0 6px 22px rgba(15,23,42,0.08);
    }

    .kpi-label {
      font-size: 12px;
      color: var(--text-muted);
      margin-bottom: 3px;
    }

    .kpi-value {
      font-size: 17px;
      font-weight: 700;
      display: flex;
      align-items: baseline;
      gap: 4px;
    }

    .kpi-unit {
      font-size: 11px;
      color: var(--text-muted);
    }

    .kpi-note {
      margin-top: 3px;
      font-size: 11px;
      display: inline-flex;
      align-items: center;
      gap: 5px;
      padding: 2px 7px;
      border-radius: 999px;
      color: var(--primary);
      background: rgba(11,95,90,0.06);
    }

    .kpi-note.bad { color: var(--danger); background: rgba(198,40,40,0.06); }

    .kpi-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: currentColor;
    }

    .mode-indicator {
      margin-top: 10px;
      font-size: 11px;
      color: var(--text-muted);
    }

    .mode-indicator span {
      font-weight: 600;
      color: var(--accent);
    }

    #chart {
      width: 100%;
      height: 310px;
    }

    /* FOOTER */
    .footer {
      margin-top: 20px;
      background: rgba(255,255,255,0.98);
      border-radius: 16px;
      padding: 12px 14px 10px;
      box-shadow: var(--shadow);
      font-size: 12px;
      color: var(--text-muted);
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .footer-top {
      display: flex;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 8px;
    }

    .footer-powered {
      color: var(--primary);
      font-weight: 600;
    }

    .footer-disc {
      font-size: 11px;
      color: #607d8b;
      line-height: 1.6;
    }

    /* RESPONSIVE DESIGN */
    @media (max-width: 1000px) {
      .layout { grid-template-columns: minmax(0, 1fr); }
    }

    @media (max-width: 768px) {
      .header {
        margin-top: 50px;
        padding: 15px;
      }

      .header-main {
        flex-direction: column;
        align-items: flex-start;
        gap: 15px;
      }

      .header-title {
        font-size: 20px;
      }

      .header-logo {
        width: 50px;
        height: 50px;
      }

      .year-filter {
        width: 100%;
        align-items: flex-start;
      }

      .year-buttons {
        justify-content: flex-start;
      }

      .tabs {
        gap: 6px;
      }

      .tab-btn {
        padding: 6px 14px;
        font-size: 13px;
      }

      .logout-btn {
        padding: 8px 12px;
        font-size: 12px;
      }

      .login-container {
        padding: 30px 20px;
      }

      .logo-svg {
        width: 80px;
        height: 80px;
      }

      .login-title {
        font-size: 22px;
      }
    }

    @media (max-width: 480px) {
      .shell {
        padding: 0 12px;
      }

      .header {
        margin-top: 40px;
      }

      .header-title {
        font-size: 18px;
      }

      .header-subtitle {
        font-size: 12px;
      }

      .logout-container {
        top: 15px;
        left: 15px;
      }

      .logout-btn {
        padding: 6px 10px;
        font-size: 11px;
      }

      .logout-btn svg {
        width: 14px;
        height: 14px;
      }

      .tab-btn {
        padding: 5px 12px;
        font-size: 12px;
      }

      .kpis {
        grid-template-columns: 1fr;
      }

      .panel {
        padding: 14px 16px;
      }

      .panel-title {
        font-size: 15px;
      }

      .login-title {
        font-size: 20px;
      }

      .form-input {
        padding: 12px 14px;
      }

      .login-btn {
        padding: 14px;
      }
    }

    @media (max-height: 600px) {
      .login-screen {
        align-items: flex-start;
        padding-top: 40px;
      }
    }
  </style>
</head>
<body>
  <!-- LOGOUT BUTTON -->
  <div class="logout-container" id="logoutContainer">
    <button class="logout-btn" id="logoutBtn">
      <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
        <path d="M6 14H3a1 1 0 0 1-1-1V3a1 1 0 0 1 1-1h3" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
        <path d="M10 11l3-3-3-3" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
        <path d="M13 8H6" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
      </svg>
      تسجيل الخروج
    </button>
  </div>

  <!-- LOGIN SCREEN -->
  <div class="login-screen" id="loginScreen">
    <div class="login-container">
      <div class="login-logo">
        <svg class="logo-svg" viewBox="0 0 120 120" fill="none">
          <!-- Main circle -->
          <circle cx="60" cy="60" r="56" fill="white" stroke="#0b5f5a" stroke-width="2"/>
          <!-- RBA text -->
          <text x="60" y="45" text-anchor="middle" font-family="Arial, sans-serif" font-size="28" font-weight="bold" fill="#0b5f5a">RBA</text>
          <!-- Accounting symbols -->
          <rect x="45" y="60" width="30" height="15" rx="2" fill="#0b5f5a" opacity="0.8"/>
          <rect x="50" y="75" width="20" height="10" rx="1" fill="#f9a825"/>
          <!-- Calculator buttons -->
          <circle cx="45" cy="90" r="4" fill="#0b5f5a" opacity="0.6"/>
          <circle cx="60" cy="90" r="4" fill="#0b5f5a" opacity="0.6"/>
          <circle cx="75" cy="90" r="4" fill="#0b5f5a" opacity="0.6"/>
          <!-- Bottom text -->
          <text x="60" y="110" text-anchor="middle" font-family="Arial, sans-serif" font-size="12" fill="#7b8794">Accounting</text>
        </svg>
        <h1 class="login-title">شركة رياض بن بليهد</h1>
        <p class="login-subtitle">لوحة التحكم المالية المتقدمة</p>
      </div>
      
      <form class="login-form" id="loginForm">
        <div class="form-group">
          <label class="form-label">اسم المستخدم</label>
          <input type="text" class="form-input" id="username" placeholder="أدخل اسم المستخدم" required autocomplete="username">
        </div>
        
        <div class="form-group">
          <label class="form-label">كلمة المرور</label>
          <input type="password" class="form-input" id="password" placeholder="أدخل كلمة المرور" required autocomplete="current-password">
        </div>
        
        <button type="submit" class="login-btn">تسجيل الدخول</button>
        <div class="login-error" id="loginError">اسم المستخدم أو كلمة المرور غير صحيحة</div>
      </form>
    </div>
  </div>

  <!-- MAIN DASHBOARD -->
  <div class="shell" id="dashboard">
    <!-- HEADER -->
    <header class="header">
      <div class="header-main">
        <svg class="header-logo" viewBox="0 0 60 60" fill="none">
          <circle cx="30" cy="30" r="28" fill="#0b5f5a"/>
          <text x="30" y="25" text-anchor="middle" font-family="Arial, sans-serif" font-size="16" font-weight="bold" fill="white">RBA</text>
          <rect x="20" y="32" width="20" height="8" rx="1" fill="#f9a825"/>
          <circle cx="23" cy="45" r="2" fill="white" opacity="0.8"/>
          <circle cx="30" cy="45" r="2" fill="white" opacity="0.8"/>
          <circle cx="37" cy="45" r="2" fill="white" opacity="0.8"/>
        </svg>
        <div>
          <h1 class="header-title">شركة رياض بن بليهد للاستشارات المحاسبية</h1>
          <p class="header-subtitle">لوحة مؤشرات مالية مختصرة – شركة الطريق المختصر للتسويق</p>
          <div class="header-tag">
            <span class="header-tag-dot"></span>
            RBA Financial Insights Snapshot
          </div>
        </div>
      </div>

      <div class="year-filter">
        <div class="year-label">تصفية حسب السنة:</div>
        <div class="year-buttons">
          <button type="button" class="year-btn" data-year="2023">
            <span class="year-btn-dot"></span>
            <span>2023</span>
          </button>
          <button type="button" class="year-btn" data-year="2024">
            <span class="year-btn-dot"></span>
            <span>2024</span>
          </button>
        </div>
        <div class="year-hint">
          في حال عدم اختيار أي سنة يتم عرض <span>المجمل الكلي (Total)</span> كما في Power BI.
        </div>
      </div>
    </header>

    <!-- TABS -->
    <nav class="tabs">
      <button class="tab-btn tab-active" data-section="main">
        <span class="tab-dot"></span> الرئيسية
      </button>
      <button class="tab-btn" data-section="revenues">
        <span class="tab-dot"></span> الإيرادات
      </button>
      <button class="tab-btn" data-section="expenses">
        <span class="tab-dot"></span> المصروفات
      </button>
      <button class="tab-btn" data-section="liabilities">
        <span class="tab-dot"></span> المطلوبات
      </button>
      <button class="tab-btn" data-section="assets">
        <span class="tab-dot"></span> الموجودات
      </button>
      <button class="tab-btn" data-section="equity">
        <span class="tab-dot"></span> حقوق الملكية
      </button>
    </nav>

    <!-- LAYOUT -->
    <section class="layout">
      <!-- KPIs -->
      <div class="panel">
        <div class="panel-inner">
          <div class="panel-header">
            <div>
              <h2 class="panel-title" id="panel-title">نظرة عامة على الأداء</h2>
              <p class="panel-subtitle" id="panel-subtitle">مؤشرات مختصرة لأهم النتائج المالية.</p>
            </div>
            <div class="panel-meta" id="panel-meta">المجمل الكلي لجميع السنوات</div>
          </div>

          <div class="kpis" id="kpi-container">
            <!-- KPIs injected -->
          </div>

          <div class="mode-indicator" id="mode-indicator">
            الوضع الحالي: <span>مجمل السنوات (Total)</span>
          </div>
        </div>
      </div>

      <!-- CHART -->
      <div class="panel">
        <div class="panel-inner">
          <div class="panel-header">
            <div>
              <h2 class="panel-title" id="chart-title">مخطط تحليلي</h2>
              <p class="panel-subtitle" id="chart-subtitle">توزيع مبسط حسب أهم البنود.</p>
            </div>
          </div>
          <div id="chart"></div>
        </div>
      </div>
    </section>

    <!-- FOOTER -->
    <footer class="footer">
      <div class="footer-top">
        <span class="footer-powered">Powered by RBA Audit Team</span>
        <span>RBA – Riyadh Bin Blihed for Accounting & Financial Consultancy</span>
      </div>
      <p class="footer-disc">
        تم إعداد هذه اللوحة التحليلية بناءً على البيانات المالية والمعلومات التي تم مشاركتها مع فريق
        شركة رياض بن بليهد للاستشارات المحاسبية. لا يتحمل فريق العمل أي مسؤولية عن أي أخطاء ناتجة عن
        عدم دقة أو اكتمال البيانات المقدمة من العميل. هذا العرض مخصص لأغراض التحليل الداخلي ودعم اتخاذ
        القرار، ولا يُعد بديلاً عن القوائم المالية المعتمدة أو التقارير النظامية.
      </p>
    </footer>
  </div>

<script>
  // ================== LOGIN SYSTEM ==================
  const CORRECT_USERNAME = "admin";
  const CORRECT_PASSWORD = "123";

  const loginScreen = document.getElementById("loginScreen");
  const dashboard = document.getElementById("dashboard");
  const loginForm = document.getElementById("loginForm");
  const loginError = document.getElementById("loginError");
  const logoutBtn = document.getElementById("logoutBtn");
  const logoutContainer = document.getElementById("logoutContainer");
  const usernameInput = document.getElementById("username");
  const passwordInput = document.getElementById("password");

  // Check if user is already logged in
  function checkAuth() {
    const isLoggedIn = localStorage.getItem("rbaLoggedIn");
    if (isLoggedIn === "true") {
      showDashboard();
    } else {
      // Focus on username input when login screen loads
      setTimeout(() => {
        usernameInput.focus();
      }, 300);
    }
  }

  // Show dashboard
  function showDashboard() {
    loginScreen.classList.add("hidden");
    dashboard.classList.add("visible");
    logoutContainer.classList.add("visible");
    
    setTimeout(() => {
      loginScreen.style.display = "none";
      // Update dashboard view
      updateView();
    }, 300);
    
    // Focus management for accessibility
    logoutBtn.focus();
  }

  // Show login screen
  function showLogin() {
    loginScreen.style.display = "flex";
    setTimeout(() => {
      loginScreen.classList.remove("hidden");
      dashboard.classList.remove("visible");
      logoutContainer.classList.remove("visible");
      usernameInput.focus();
    }, 50);
    
    // Clear inputs
    usernameInput.value = "";
    passwordInput.value = "";
    loginError.classList.remove("show");
  }

  // Handle login
  loginForm.addEventListener("submit", function(e) {
    e.preventDefault();
    
    const username = usernameInput.value.trim();
    const password = passwordInput.value.trim();
    
    if (username === CORRECT_USERNAME && password === CORRECT_PASSWORD) {
      // Successful login
      localStorage.setItem("rbaLoggedIn", "true");
      showDashboard();
    } else {
      // Failed login
      loginError.classList.add("show");
      passwordInput.value = "";
      passwordInput.focus();
      
      // Shake animation
      loginForm.style.animation = "none";
      setTimeout(() => {
        loginForm.style.animation = "shake 0.5s";
      }, 10);
    }
  });

  // Handle logout
  logoutBtn.addEventListener("click", function() {
    localStorage.removeItem("rbaLoggedIn");
    showLogin();
  });

  // Add shake animation
  const style = document.createElement('style');
  style.textContent = `
    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
      20%, 40%, 60%, 80% { transform: translateX(5px); }
    }
  `;
  document.head.appendChild(style);

  // Handle Enter key for login
  passwordInput.addEventListener("keypress", function(e) {
    if (e.key === "Enter") {
      loginForm.requestSubmit();
    }
  });

  // Initial check
  checkAuth();

  // ================== نموذج بيانات (بدّله بأرقامك الحقيقة من Power BI) ==================
  const dashboardModel = {
    main: {
      total: {
        title: "النظرة الإجمالية – مجمل السنوات",
        subtitle: "كما تظهر في Power BI عند عدم اختيار سنة.",
        meta: "إجمالي 2023 + 2024",
        kpis: [
          { label: "الإيرادات", value: 127.1, unit: "مليون ر.س", positive: true },
          { label: "تكلفة الإيرادات", value: -79.9, unit: "مليون ر.س", positive: false },
          { label: "المصروفات", value: -30.2, unit: "مليون ر.س", positive: false },
          { label: "مجمل الربح", value: 47.2, unit: "مليون ر.س", positive: true },
          { label: "ضريبة الدخل", value: -3.0, unit: "مليون ر.س", positive: false },
          { label: "صافي الربح قبل الضريبة", value: 17.1, unit: "مليون ر.س", positive: true }
        ],
        chart: {
          type: "bar",
          title: "مجمل الربح حسب السنة",
          subtitle: "أرقام تقريبية، عدّلها لتطابق تقريرك.",
          categories: ["2023", "2024"],
          series: [
            { name: "مجمل الربح (مليون ر.س)", data: [21.3, 25.9] }
          ]
        }
      },
      years: {
        "2023": {
          title: "نتائج سنة 2023",
          subtitle: "يمكن تعديل القيم حسب ما يظهر في Power BI.",
          meta: "سنة 2023 فقط",
          kpis: [
            { label: "الإيرادات", value: 62.5, unit: "مليون ر.س", positive: true },
            { label: "تكلفة الإيرادات", value: -41.2, unit: "مليون ر.س", positive: false },
            { label: "المصروفات", value: -11.8, unit: "مليون ر.س", positive: false },
            { label: "مجمل الربح", value: 21.3, unit: "مليون ر.س", positive: true },
            { label: "ضريبة الدخل", value: -2.0, unit: "مليون ر.س", positive: false },
            { label: "صافي الربح قبل الضريبة", value: 8.5, unit: "مليون ر.س", positive: true }
          ],
          chart: {
            type: "bar",
            title: "مجمل الربح – 2023",
            subtitle: "",
            categories: ["مجمل الربح"],
            series: [
              { name: "2023", data: [21.3] }
            ]
          }
        },
        "2024": {
          title: "نتائج سنة 2024",
          subtitle: "",
          meta: "سنة 2024 فقط",
          kpis: [
            { label: "الإيرادات", value: 64.6, unit: "مليون ر.س", positive: true },
            { label: "تكلفة الإيرادات", value: -38.7, unit: "مليون ر.س", positive: false },
            { label: "المصروفات", value: -18.4, unit: "مليون ر.س", positive: false },
            { label: "مجمل الربح", value: 25.9, unit: "مليون ر.س", positive: true },
            { label: "ضريبة الدخل", value: -3.0, unit: "مليون ر.س", positive: false },
            { label: "صافي الربح قبل الضريبة", value: 9.9, unit: "مليون ر.س", positive: true }
          ],
          chart: {
            type: "bar",
            title: "مجمل الربح – 2024",
            subtitle: "",
            categories: ["مجمل الربح"],
            series: [
              { name: "2024", data: [25.9] }
            ]
          }
        }
      }
    },

    revenues: {
      total: {
        title: "الإيرادات – مجمل السنوات",
        subtitle: "توزيع الإيرادات حسب نوع الحساب.",
        meta: "إجمالي الإيرادات لكل السنوات",
        kpis: [
          { label: "الإيرادات الكلية", value: 127.1, unit: "مليون ر.س", positive: true },
          { label: "مبيعات واتس شل", value: 76.7, unit: "مليون ر.س", positive: true },
          { label: "المبيعات الأخرى", value: 50.4, unit: "مليون ر.س", positive: true }
        ],
        chart: {
          type: "donut",
          title: "الإيرادات حسب نوع الحساب",
          subtitle: "",
          categories: ["مبيعات واتس شل", "مبيعات أخرى", "المرتجعات"],
          series: [76.7, 50.4, -3.9]
        }
      },
      years: {
        "2023": {
          title: "الإيرادات – 2023",
          subtitle: "",
          meta: "سنة 2023",
          kpis: [
            { label: "الإيرادات", value: 62.5, unit: "مليون ر.س", positive: true }
          ],
          chart: {
            type: "donut",
            title: "الإيرادات – 2023",
            subtitle: "",
            categories: ["مبيعات", "واتس شل", "فلورا", "مرتجعات"],
            series: [49.8, 21.3, 0.3, -8.9]
          }
        },
        "2024": {
          title: "الإيرادات – 2024",
          subtitle: "",
          meta: "سنة 2024",
          kpis: [
            { label: "الإيرادات", value: 64.6, unit: "مليون ر.س", positive: true }
          ],
          chart: {
            type: "donut",
            title: "الإيرادات – 2024",
            subtitle: "",
            categories: ["مبيعات", "واتس شل", "فلورا", "مرتجعات"],
            series: [35.9, 34.1, 0.3, -5.8]
          }
        }
      }
    },

    expenses: {
      total: {
        title: "المصروفات – مجمل السنوات",
        subtitle: "توزيع المصروفات حسب طبيعة البند.",
        meta: "إجمالي المصروفات",
        kpis: [
          { label: "إجمالي المصروفات", value: -30.2, unit: "مليون ر.س", positive: false },
          { label: "مصروفات تسويقية", value: -24.2, unit: "مليون ر.س", positive: false },
          { label: "مصروفات عمومية وإدارية", value: -5.9, unit: "مليون ر.س", positive: false }
        ],
        chart: {
          type: "treemap",
          title: "Treemap (شكلي) للمصروفات",
          subtitle: "يمكنك تحويل الألوان/القيم لاحقاً.",
          categories: ["تسويق مشاهير", "تسويق واتس شل", "عمومية وإدارية", "استهلاك أصول"],
          series: [18, 6.2, 5.9, 3.1]
        }
      },
      years: {}
    },

    liabilities: {
      total: {
        title: "إجمالي المطلوبات",
        subtitle: "",
        meta: "مطلوبات متداولة وأخرى",
        kpis: [
          { label: "إجمالي المطلوبات", value: 5.69, unit: "مليون ر.س", positive: false }
        ],
        chart: {
          type: "donut",
          title: "المطلوبات حسب نوع الحساب",
          subtitle: "",
          categories: ["ضريبة الدخل المستحقة", "ضريبة القيمة المضافة", "موردون", "أخرى"],
          series: [1.9, 2.3, 0.9, 0.6]
        }
      },
      years: {}
    },

    assets: {
      total: {
        title: "الموجودات – مجمل السنوات",
        subtitle: "",
        meta: "الموجودات المتداولة وغير المتداولة",
        kpis: [
          { label: "إجمالي الموجودات", value: -22.76, unit: "مليون ر.س", positive: false }
        ],
        chart: {
          type: "donut",
          title: "الموجودات حسب نوع الحساب",
          subtitle: "",
          categories: ["ذمم مدينة", "مخزون", "نقد وبنوك", "أخرى"],
          series: [9.8, 6.0, 2.1, 4.8]
        }
      },
      years: {}
    },

    equity: {
      total: {
        title: "حقوق الملكية – مجمل السنوات",
        subtitle: "",
        meta: "رأس المال + احتياطي + أرباح مرحلة",
        kpis: [
          { label: "إجمالي حقوق الملكية", value: 11.25, unit: "مليون ر.س", positive: true }
        ],
        chart: {
          type: "donut",
          title: "حقوق الملكية حسب البند",
          subtitle: "",
          categories: ["أرباح وخسائر مرحلة", "رأس المال", "احتياطي نظامي"],
          series: [11.0, 0.25, 0.01]
        }
      },
      years: {}
    }
  };

  // ================== منطق الواجهة ==================
  let currentSection = "main";
  let currentChart = null;

  const kpiContainer = document.getElementById("kpi-container");
  const panelTitle = document.getElementById("panel-title");
  const panelSubtitle = document.getElementById("panel-subtitle");
  const panelMeta = document.getElementById("panel-meta");
  const modeIndicator = document.getElementById("mode-indicator");
  const chartTitle = document.getElementById("chart-title");
  const chartSubtitle = document.getElementById("chart-subtitle");

  const yearButtons = document.querySelectorAll(".year-btn");
  const tabButtons = document.querySelectorAll(".tab-btn");

  function getSelectedYears() {
    const selected = [];
    yearButtons.forEach(btn => {
      if (btn.classList.contains("year-btn-active")) {
        selected.push(btn.dataset.year);
      }
    });
    return selected;
  }

  function getSectionData() {
    const section = dashboardModel[currentSection];
    const selectedYears = getSelectedYears();

    if (!selectedYears.length) {
      // لا توجد سنة محددة -> مجمل
      return { mode: "total", year: null, data: section.total };
    }

    // لو سنة واحدة أو أكثر: نأخذ أول سنة إن كان لها بيانات، وإلا نرجع للمجمل
    const yr = selectedYears[0];
    const yearData = section.years && section.years[yr] && Object.keys(section.years[yr]).length
      ? section.years[yr]
      : section.total;

    return { mode: "year", year: yr, data: yearData };
  }

  function renderKpis(kpis) {
    kpiContainer.innerHTML = "";
    if (!kpis || !kpis.length) {
      kpiContainer.innerHTML = "<p style='font-size:12px;color:#9fb3c8;'>لا توجد مؤشرات معرفة حالياً لهذا التبويب.</p>";
      return;
    }

    kpis.forEach(kpi => {
      const card = document.createElement("div");
      card.className = "kpi-card";

      const labelEl = document.createElement("div");
      labelEl.className = "kpi-label";
      labelEl.textContent = kpi.label;

      const valueRow = document.createElement("div");
      valueRow.className = "kpi-value";
      const valueSpan = document.createElement("span");
      valueSpan.textContent = kpi.value.toLocaleString("ar-EG", { maximumFractionDigits: 2 });
      const unitSpan = document.createElement("span");
      unitSpan.className = "kpi-unit";
      unitSpan.textContent = kpi.unit || "";
      valueRow.appendChild(valueSpan);
      valueRow.appendChild(unitSpan);

      const note = document.createElement("div");
      note.className = "kpi-note" + (kpi.positive ? "" : " bad");
      const dot = document.createElement("span");
      dot.className = "kpi-dot";
      const text = document.createElement("span");
      text.textContent = kpi.positive ? "مؤشر إيجابي" : "مؤشر عبء/استهلاك";
      note.appendChild(dot);
      note.appendChild(text);

      card.appendChild(labelEl);
      card.appendChild(valueRow);
      card.appendChild(note);
      kpiContainer.appendChild(card);
    });
  }

  function renderChart(chartCfg) {
    const chartEl = document.querySelector("#chart");
    if (currentChart) {
      currentChart.destroy();
    }

    if (!chartCfg) return;

    const type = chartCfg.type || "bar";
    let options;

    if (type === "bar") {
      options = {
        chart: {
          type: "bar",
          height: 310,
          toolbar: { show: false },
          animations: { enabled: true, easing: "easeout", speed: 500 }
        },
        series: chartCfg.series,
        xaxis: {
          categories: chartCfg.categories || [],
          labels: { style: { fontFamily: "Cairo" } }
        },
        yaxis: {
          labels: { style: { fontFamily: "Cairo" } }
        },
        plotOptions: {
          bar: {
            borderRadius: 6,
            columnWidth: "45%"
          }
        },
        dataLabels: { enabled: false },
        colors: ["#2e7d32", "#66bb6a", "#26a69a"],
        legend: {
          fontFamily: "Cairo",
          position: "bottom"
        },
        tooltip: {
          y: {
            formatter: val => val + " م.ر.س"
          }
        }
      };
    } else if (type === "donut") {
      options = {
        chart: {
          type: "donut",
          height: 310,
          toolbar: { show: false },
          animations: { enabled: true, easing: "easeinout", speed: 600 }
        },
        series: chartCfg.series,
        labels: chartCfg.categories,
        legend: {
          position: "right",
          fontFamily: "Cairo"
        },
        dataLabels: { enabled: true },
        colors: ["#26a69a", "#42a5f5", "#ffb74d", "#ef5350", "#7e57c2"],
        plotOptions: {
          pie: {
            donut: {
              size: "65%",
              labels: {
                show: true,
                name: { show: true, fontFamily: "Cairo" },
                value: {
                  show: true,
                  fontFamily: "Cairo",
                  formatter: val => val + " م.ر.س"
                },
                total: {
                  show: true,
                  label: "الإجمالي",
                  fontFamily: "Cairo",
                  formatter: function (w) {
                    const sum = w.globals.seriesTotals.reduce((a, b) => a + b, 0);
                    return sum.toFixed(1) + " م.ر.س";
                  }
                }
              }
            }
          }
        },
        tooltip: {
          y: {
            formatter: val => val + " م.ر.س"
          }
        }
      };
    } else if (type === "treemap") {
      // Treemap "شكلي" باستخدام bar stacked
      options = {
        chart: {
          type: "bar",
          stacked: true,
          height: 310,
          toolbar: { show: false }
        },
        series: [{
          name: "قيمة",
          data: chartCfg.series
        }],
        xaxis: {
          categories: chartCfg.categories,
          labels: { style: { fontFamily: "Cairo" } }
        },
        plotOptions: {
          bar: {
            horizontal: true,
            barHeight: "60%",
            distributed: true
          }
        },
        dataLabels: {
          enabled: true,
          formatter: val => val + " م.ر.س"
        },
        colors: ["#26a69a", "#66bb6a", "#42a5f5", "#ffb74d", "#ab47bc"],
        legend: { show: false },
        tooltip: {
          y: { formatter: val => val + " م.ر.س" }
        }
      };
    }

    currentChart = new ApexCharts(chartEl, options);
    currentChart.render();
  }

  function updateView() {
    const { mode, year, data } = getSectionData();

    panelTitle.textContent = data.title || "";
    panelSubtitle.textContent = data.subtitle || "";
    panelMeta.textContent = data.meta || "";

    chartTitle.textContent = (data.chart && data.chart.title) || "مخطط تحليلي";
    chartSubtitle.textContent = (data.chart && data.chart.subtitle) || "";

    if (mode === "total") {
      modeIndicator.innerHTML = "الوضع الحالي: <span>مجمل السنوات (Total)</span>";
    } else {
      modeIndicator.innerHTML = "الوضع الحالي: بيانات سنة <span>" + year + "</span>";
    }

    renderKpis(data.kpis || []);
    renderChart(data.chart);
  }

  // EVENTS
  yearButtons.forEach(btn => {
    btn.addEventListener("click", () => {
      btn.classList.toggle("year-btn-active");
      updateView();
    });
  });

  tabButtons.forEach(btn => {
    btn.addEventListener("click", () => {
      tabButtons.forEach(b => b.classList.remove("tab-active"));
      btn.classList.add("tab-active");
      currentSection = btn.dataset.section;
      updateView();
    });
  });

  // INIT (only if logged in)
  if (localStorage.getItem("rbaLoggedIn") === "true") {
    updateView();
  }
</script>
</body>
</html>